<?php 
/**
 * @category   OntoWiki
 * @package    OntoWiki_extensions_formgenerator
 * @author     Lars Eidam <larseidam@googlemail.com>
 * @author     Konrad Abicht <konrad@inspirito.de>
 * @copyright  Copyright (c) 2011
 * @license    http://opensource.org/licenses/gpl-license.php GNU General Public License (GPL)
 */ 

$element ['outputOptions'] = array ();

// get information about the topic
$topic = $this->alsfrsModel->sparqlQuery(
    'SELECT ?topicUri ?label ?suggestedQuestion
     WHERE {
         <'. $element ['predicateuri'] .'> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://als.dispedia.de/frs/o/Topic> .
         <'. $element ['predicateuri'] .'> <http://www.w3.org/2000/01/rdf-schema#label> ?label .
         <'. $element ['predicateuri'] .'> <http://als.dispedia.de/frs/o/suggestedQuestion> ?suggestedQuestion .
         FILTER (langmatches(lang(?label), "'. $this->selectedLanguage .'"))
     };'
);

$element ['label'] = $topic [0]['label'];
$element ['suggestedQuestion'] = $topic [0]['suggestedQuestion'];

// get information about all options of the topic
foreach ( $element ['typeparameter']['options'] as $option ) {
    
    // TODO add language selection
    
    $o = $this->alsfrsModel->sparqlQuery(
        'SELECT ?optionUri ?label ?score
         WHERE {
             ?optionUri <http://www.w3.org/2000/01/rdf-schema#label> ?label .
             <'. $option .'> <http://www.w3.org/2000/01/rdf-schema#label> ?label .
             <'. $option .'> <http://als.dispedia.de/frs/o/hasScore> ?score .
             FILTER (langmatches(lang(?label), "'. $this->selectedLanguage .'"))
         } 
         ORDER BY ?score;'
    );
    
    $o [0] ['optionValue'] = $option;    
    $element ['outputOptions'][] = $o [0];
}

$entrySelected = false;

// Get latest score
$setOptions = array ();

if ('PropertySet' == $element ['typeparameter']['pertainsTo']) {
    
    $tmp = $this->selectedModel->sparqlQuery(
        'SELECT ?setOption
         WHERE {
             <'. $this->selectedResource .'> <'. $this->formulaParameter ['predicateToHealthState'] .'> ?healthState .
             ?healthState <'. $this->formulaParameter ['predicateToPropertySet'] .'> ?propertySet .
             ?propertySet <'. $this->formulaParameter ['predicateToPropertyOption'] .'> ?setOption .
         };'
    );
    
    foreach ( $tmp as $option ) {
        $setOptions [] = $option ['setOption'];
        $entrySelected = true;
    }
    
} elseif ('SymptomSet' == $element ['typeparameter']['pertainsTo']) {
 
    $tmp = $this->selectedModel->sparqlQuery(
        'SELECT ?setOption
         WHERE {
             <'. $this->selectedResource .'> <'. $this->formulaParameter ['predicateToHealthState'] .'> ?healthState .
             ?healthState <'. $this->formulaParameter ['predicateToSymptomSet'] .'> ?symptomSet .
             ?symptomSet <'. $this->formulaParameter ['predicateToSymptomOption'] .'> ?setOption .
         };'
    );
    
    foreach ( $tmp as $option ) {
        $setOptions [] = $option ['setOption'];
        $entrySelected = true;
    }
}

?>
<!-- suggested question -->
<h2><?php echo $element ['suggestedQuestion']; ?></h2>

<!-- list of options -->
<?php foreach ( $element ['outputOptions'] as $option ) { ?>

    <br/>
    
    <?php if ( true == in_array ( $option ['optionValue'], $setOptions ) ) { ?>
    
    <input type="radio" name="<?php echo $element ['name'] ?>" value="<?php echo $option ['optionValue']; ?>" checked="checked"/>
    
    <?php } elseif ( false == $entrySelected ) { $entrySelected = true; ?>
    
    <input type="radio" name="<?php echo $element ['name'] ?>" value="<?php echo $option ['optionValue']; ?>" checked="checked"/>
    
    <?php } else { ?>
    
    <input type="radio" name="<?php echo $element ['name'] ?>" value="<?php echo $option ['optionValue']; ?>"/>
    
    <?php } ?>
    
    &nbsp; <?php echo $option ['label']; ?>

<?php } ?>
    
